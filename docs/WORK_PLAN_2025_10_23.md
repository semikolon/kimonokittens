# Work Plan - October 23, 2025

## Session Context
Continuing work from Codex session (Oct 21-23) on model migration completion and test cleanup.

## Completed Today ‚úÖ

1. **Disabled Legacy WebSocket Integration Spec**
   - File: `spec/websocket_integration_spec.rb`
   - Reason: Legacy Agoo/json_server dependency (migrated to Puma)
   - Status: ‚úÖ Done

2. **Strava Handler Spec Migration to WebMock**
   - File: `spec/strava_workouts_handler_spec.rb`
   - Changes: Rewrote from Faraday mocking to WebMock
   - Added: `webmock` gem to Gemfile
   - Status: üîÑ 2 minor failures remaining (down from 8)

## In Progress üîÑ

### Strava Handler Spec Fixes (2 remaining failures)

**Failure 1: Token Refresh Retry**
- Issue: After token refresh, retry uses NEW token but stub only expects OLD token
- Fix needed: Add second stub for retry with `new_access_token`

**Failure 2: Error Message Format**
- Issue: Error message now includes status code: "Failed to fetch stats from Strava (500): Internal Server Error"
- Expected: "Failed to fetch stats from Strava"
- Decision: Update test expectation (code behavior is better - more specific error)

## Pending Tasks ‚è∏Ô∏è

### 3. Investigate Train Departure Handler Specs (8 failures)

**Pre-investigation work:**
- Review git history for `handlers/train_departure_handler.rb`
- Review git history for `dashboard/src/components/TrainWidget.tsx`
- Understand recent architectural changes
- Identify when methods were removed/renamed

**Known issues from spec output:**
- Missing `get_fallback_data` method (2 failures)
- Missing stdout output expectations (3 failures)
- API structure changed - missing `summary` key (2 failures)
- Faraday mocking mismatch (1 failure)

**Investigation questions:**
- Was `get_fallback_data` intentionally removed?
- Did error handling change from stdout to logging?
- Did API contract simplify (remove summary wrapper)?
- Did HTTP client change from Faraday to Net::HTTP?

### 4. Update CLAUDE.md with Repository Patterns

**Section to add:** "Repository Architecture Pattern üèóÔ∏è"

**Content:**
- Current architecture status (‚úÖ PRODUCTION - Oct 2025)
- Quick reference for `Persistence.*` module usage
- Domain model method examples
- Service layer transaction patterns
- Link to `MODEL_ARCHITECTURE.md`
- Update electricity bill timeline references (old RentDb ‚Üí new ApplyElectricityBill)

**Location:** After "Rent Calculation Timing Quirks" section

### 5. Create Production Deployment Plan Document

**File:** `docs/PRODUCTION_CRON_DEPLOYMENT.md`

**Content:**
- Database migration check (already deployed via webhook)
- Create cron wrapper script: `bin/fetch_electricity_data.sh`
- Add cron entry (daily 3am as kimonokittens user)
- Verification steps
- Expected behavior (first run vs daily runs)
- Troubleshooting guide

**Purpose:** Concise prompt for Dell kiosk Claude session

### 6. Commit All Documentation Updates

**Files to commit:**
- ‚úÖ `docs/MODEL_ARCHITECTURE.md` (created - 800 lines)
- ‚úÖ `docs/ELECTRICITY_AUTOMATION_COMPLETION_SUMMARY.md` (status updated)
- ‚úÖ `spec/websocket_integration_spec.rb` (disabled with reason)
- ‚úÖ `spec/strava_workouts_handler_spec.rb` (WebMock migration)
- ‚úÖ `Gemfile` + `Gemfile.lock` (webmock added)
- ‚è∏Ô∏è `CLAUDE.md` (waiting for task 4)
- ‚è∏Ô∏è `docs/PRODUCTION_CRON_DEPLOYMENT.md` (waiting for task 5)
- ‚è∏Ô∏è This plan document

**Commit message strategy:**
- Separate commits for logical groups:
  1. Test fixes (WebSocket disable, Strava WebMock, train fixes when complete)
  2. Documentation (MODEL_ARCHITECTURE, completion summary update)
  3. CLAUDE.md updates (repository patterns)
  4. Production deployment guide

## Context from Previous Session

### Codex's Completed Work (Oct 21-23)
- ‚úÖ Full domain model migration (commits d96d76f, d7b75ec, 7df8296)
- ‚úÖ Models, repositories, services, Persistence module
- ‚úÖ Handler migration to use new architecture
- ‚úÖ Comprehensive test coverage (targeted subset passing)
- ‚úÖ Vattenfall scraper integration with ApplyElectricityBill
- ‚úÖ All business logic preserved and verified

### Test Suite Status
- **Total:** 136 examples
- **Passing:** 119 (including all new model/repository/service tests)
- **Failing:** 16 (Strava + TrainDeparture - API mocking issues, NOT migration-related)
- **Pending:** 1 (BankBuster - Vessel dependency)

### Known Legacy Issues
- WebSocket integration spec: Agoo/json_server legacy (now disabled)
- BankBuster spec: Vessel dependency (already properly skipped)
- Handler specs: Pre-existing HTTP stubbing issues (being fixed)

## Success Criteria

### Must Complete Today:
1. ‚úÖ All Strava handler specs passing
2. ‚úÖ Train departure specs investigated and fixed (or intentionally skipped with reason)
3. ‚úÖ CLAUDE.md updated with repository patterns
4. ‚úÖ Production deployment guide created
5. ‚úÖ All documentation committed

### Nice to Have:
- Full `bundle exec rspec` passing (all 136 examples green)
- Production cron deployed on Dell kiosk (may wait for separate session)

## Timeline Estimate

- Strava fixes: 15 minutes
- Train departure investigation: 30-45 minutes (git history review)
- Train departure fixes: 30-60 minutes (depends on findings)
- CLAUDE.md updates: 20 minutes
- Production deployment guide: 15 minutes
- Commit and push: 10 minutes

**Total:** ~2-3 hours

## Notes

- All model migration work complete - focus is on test cleanup and documentation
- Specs are failing due to HTTP mocking issues, not architecture problems
- Production system is stable - this is quality improvement work
- Git history review is critical before changing train departure specs
