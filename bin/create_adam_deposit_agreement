#!/usr/bin/env ruby
# frozen_string_literal: true

# Idempotent script to create deposit agreement for Adam McCarthy
#
# This script is designed to be run automatically after deployment.
# It will only create the agreement once - subsequent runs are no-ops.
#
# Idempotency: Checks for existing SignedContract with pdfUrl containing "Depositionsavtal"
# No database migration required - uses existing pdfUrl field for identification.
#
# Usage:
#   bin/create_adam_deposit_agreement              # Production mode
#   TEST_MODE=true bin/create_adam_deposit_agreement  # Test mode (free, no real signatures)

require 'dotenv/load'
require_relative '../lib/rent_db'
require_relative '../lib/persistence'
require_relative '../lib/deposit_agreement_signer'
require_relative '../lib/repositories/tenant_repository'
require_relative '../lib/repositories/signed_contract_repository'

# Adam's details from the agreement
ADAM_PERSONNUMMER = '19890714-0357'
DEPOSIT_AMOUNT = 8_200
REPAYMENT_DEADLINE = '1 mars 2026'

def main
  puts "üîç Checking for existing deposit agreement..."

  # Check for existing deposit agreement by PDF filename pattern
  # This is the idempotency check - no migration needed
  contract_repo = SignedContractRepository.new
  existing = contract_repo.find_by_pdf_pattern('%Depositionsavtal%')

  if existing.any?
    agreement = existing.first
    puts "‚ÑπÔ∏è  Deposit agreement already exists!"
    puts "   Case ID: #{agreement.case_id}"
    puts "   Status: #{agreement.status}"
    puts "   PDF: #{agreement.pdf_url}"
    puts "   Created: #{agreement.created_at}"
    puts ""
    puts "üîÅ Skipping creation (idempotent)"
    return
  end

  # Find Adam in the database for his email
  tenant_repo = TenantRepository.new
  adam = tenant_repo.find_by_personnummer(ADAM_PERSONNUMMER)

  unless adam
    puts "‚ö†Ô∏è  Adam not found by personnummer, trying by name..."
    adam = tenant_repo.find_by_name('Adam McCarthy')
  end

  unless adam
    puts "‚ùå Adam McCarthy not found in database!"
    puts "   Cannot create deposit agreement without tenant email."
    exit 1
  end

  puts "‚úÖ Found Adam: #{adam.name} (#{adam.email})"

  # No existing agreement - create one!
  puts "\nüìú Creating new deposit agreement..."

  test_mode = ENV['TEST_MODE'] == 'true' || ENV['CONTRACT_TEST_MODE'] == 'true'

  result = DepositAgreementSigner.create_and_send(
    tenant_name: adam.name,
    tenant_personnummer: adam.personnummer || ADAM_PERSONNUMMER,
    tenant_email: adam.email,
    deposit_amount: DEPOSIT_AMOUNT,
    repayment_deadline: REPAYMENT_DEADLINE,
    test_mode: test_mode,
    send_emails: true
  )

  puts "\n‚ú® Deposit agreement created successfully!"
  puts "   Case ID: #{result[:case_id]}"
  puts "   PDF: #{result[:pdf_path]}"
  puts ""
  puts "üîó Signing links sent via SMS and email"
end

main
