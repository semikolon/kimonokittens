require 'dotenv/load'
require 'agoo'
require 'faraday'
require 'oj'
require 'awesome_print'
require 'pry'
require 'pry-nav'

# Setting the thread count to 0 causes the server to use the current
# thread. Greater than zero runs the server in a separate thread and the
# current thread can be used for other tasks as long as it does not exit.
Agoo::Log.configure(dir: '',
        console: true,
        classic: true,
        colorize: true,
        states: {
          INFO: true,
          DEBUG: false,
          connect: true,
          request: true,
          response: true,
          eval: true,
          push: false,
        })

Agoo::Server.init(6464, 'root', thread_count: 0)

KWH_PRICE = 1.3 + 1.06
# Göta Energi (electricity sales) ~ 1.30 SEK per kWh
# Vattenfall (electricity network) ~ 1.06 SEK per kWh

WDAY = {
  'Mon': 'Mån',
  'Tue': 'Tis',
  'Wed': 'Ons',
  'Thu': 'Tor',
  'Fri': 'Fre',
  'Sat': 'Lör',
  'Sun': 'Sön'
}

class ElectricityStatsHandler
  def call(req)
    electricity_stats = Oj.load_file('electricity_stats.json')

    days = electricity_stats.reverse.map do |day|
      kwh = day['consumption']
      date = DateTime.parse(day['date'])
      short_date = date.strftime("%b %-d")
      weekday = WDAY[date.strftime("%a").to_sym]
      price = (kwh * KWH_PRICE).ceil
      {
        date: short_date,
        weekday: weekday,
        full_date: "#{weekday} #{short_date}",
        price: price,
        title: "= #{price} kr (#{weekday})",
        long_title: "#{kwh} kWh = #{price} kr (#{weekday})",
        consumption: kwh
      }
    end
    price_so_far = days.sum { |day| day[:price] }
    average_day = price_so_far / days.count
    projected_total = ((average_day * 31).to_f).ceil
    days.prepend({
      price_so_far: price_so_far,
      average_day: average_day,
      projected_total: projected_total,
      last_days_summary: days[1..3].map{ |d| "#{d[:weekday]}: #{d[:price]} kr\n" }.join
    })

    # ap days
    stats = {
      electricity_stats: days,
      training_stats: []
    }
    [200, { 'Content-Type' => 'application/json' }, [ Oj.dump(stats) ]]
  end
end

class ProxyHandler
  def call(req)
    response = Faraday.get("http://192.168.0.210:1880/data/#{req['PATH_INFO'].split('/data/').last}")
    [response.status, response.headers, [response.body]]
  end
end

class HomePageHandler
  def initialize
    @content = File.read('www/index.html')
  end

  def call(req)
    [200, { 'Content-Type' => 'text/html' }, [ @content ]]
  end
end

class StaticHandler
  WWW_DIR = File.expand_path("../www", __FILE__)

  def call(req)
    path = File.join(WWW_DIR, req['PATH_INFO'])
    if File.exist?(path) && !File.directory?(path)
      Agoo::Log.info("Serving file: #{path}")
      serve_file(path)
    else
      Agoo::Log.warn("File not found: #{path}")
      [404, { 'Content-Type' => 'text/plain' }, [ "File not found." ]]
    end
  end

  private

  def serve_file(path)
    ext = File.extname(path)
    content_type = case ext
                   when '.html'
                     'text/html'
                   when '.css'
                     'text/css'
                   when '.js'
                     'application/javascript'
                   when '.png'
                     'image/png'
                   when '.jpg', '.jpeg'
                     'image/jpeg'
                   when '.gif'
                     'image/gif'
                   else
                     'application/octet-stream'
                   end
    [200, { 'Content-Type' => content_type }, [ File.read(path) ]]
  end
end

def to_sentence(array)
  if array.size > 1
    last = array.pop
    "#{array.join(', ')} och #{last}"
  else
    array.first
  end
end

class TrainDepartureHandler
  SL_API_KEY = ENV['SL_API_KEY']
  SITE_ID = 9527 # From https://api.sl.se/api2/typeahead.json?key=#{SL_API_KEY}&searchstring=Huddinge%20station&stationsonly=true&maxresults=2
  TIME_WINDOW = 60 # time in minutes to fetch departures for, max 60
  WALK_TIME = 8 # time in minutes to walk to the station
  RUN_TIME = 5 # time in minutes to cycle or run to the station
  MARGIN_TIME = 5 # time in minutes for alarm margin to get ready
  CACHE_THRESHOLD = 60 * 5 # time in seconds to keep data in cache

  def initialize
    @data = nil
    @fetched_at = nil
  end

  def call(req)
    # For testing:
    #@data = Oj.load_file('train_examples.json')
    #@data = Oj.load_file('train_examples_deviations.json')
    #@fetched_at = Time.now

    if @data.nil? || Time.now - @fetched_at > CACHE_THRESHOLD
      response = Faraday.get("https://api.sl.se/api2/realtimedeparturesV4.json?key=#{SL_API_KEY}&siteid=#{SITE_ID}&timewindow=#{TIME_WINDOW}")

      if response.success?
        @data = Oj.load(response.body)
        @fetched_at = Time.now
      else
        return [500, { 'Content-Type' => 'application/json' }, [ Oj.dump({ 'error': 'Failed to fetch train departures' }) ]]
      end
    end

    ap @data
    # Example:
    # [7] {
    #   "SecondaryDestinationName" => nil,
    #                "GroupOfLine" => "Pendeltåg",
    #              "TransportMode" => "TRAIN",
    #                 "LineNumber" => "41",
    #                "Destination" => "Södertälje centrum",
    #           "JourneyDirection" => 1,
    #               "StopAreaName" => "Huddinge",
    #             "StopAreaNumber" => 5161,
    #            "StopPointNumber" => 5161,
    #       "StopPointDesignation" => "3",
    #         "TimeTabledDateTime" => "2023-07-02T15:55:00",
    #           "ExpectedDateTime" => "2023-07-02T15:55:00",
    #                "DisplayTime" => "15:55",
    #              "JourneyNumber" => 2947,
    #                 "Deviations" => [
    #       [0] {
    #                      "Text" => "Inställd på grund av personalbrist.",
    #               "Consequence" => "INFORMATION",
    #           "ImportanceLevel" => 7
    #       }

    # Bus example data:
  #   "Buses" => [
  #     [ 0] {
  #                  "GroupOfLine" => nil,
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "740",
  #                  "Destination" => "Kungens kurva",
  #             "JourneyDirection" => 2,
  #                 "StopAreaName" => "Huddinge station",
  #               "StopAreaNumber" => 70108,
  #              "StopPointNumber" => 70357,
  #         "StopPointDesignation" => "D",
  #           "TimeTabledDateTime" => "2023-07-02T17:01:00",
  #             "ExpectedDateTime" => "2023-07-02T17:01:00",
  #                  "DisplayTime" => "Nu",
  #                "JourneyNumber" => 32198,
  #                   "Deviations" => nil
  #     },
  #     [ 1] {
  #                  "GroupOfLine" => nil,
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "710",
  #                  "Destination" => "Sörskogen",
  #             "JourneyDirection" => 1,
  #                 "StopAreaName" => "Huddinge centrum",
  #               "StopAreaNumber" => 70088,
  #              "StopPointNumber" => 70089,
  #         "StopPointDesignation" => "K",
  #           "TimeTabledDateTime" => "2023-07-02T17:01:00",
  #             "ExpectedDateTime" => "2023-07-02T17:01:03",
  #                  "DisplayTime" => "Nu",
  #                "JourneyNumber" => 29648,
  #                   "Deviations" => nil
  #     },
  #     [ 2] {
  #                  "GroupOfLine" => "blåbuss",
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "172",
  #                  "Destination" => "Norsborg",
  #             "JourneyDirection" => 2,
  #                 "StopAreaName" => "Huddinge station",
  #               "StopAreaNumber" => 70108,
  #              "StopPointNumber" => 70479,
  #         "StopPointDesignation" => "B",
  #           "TimeTabledDateTime" => "2023-07-02T17:02:00",
  #             "ExpectedDateTime" => "2023-07-02T17:02:00",
  #                  "DisplayTime" => "17:02",
  #                "JourneyNumber" => 19318,
  #                   "Deviations" => nil
  #     },
  #     [ 3] {
  #                  "GroupOfLine" => nil,
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "706",
  #                  "Destination" => "Källbrink",
  #             "JourneyDirection" => 1,
  #                 "StopAreaName" => "Huddinge station",
  #               "StopAreaNumber" => 70108,
  #              "StopPointNumber" => 70354,
  #         "StopPointDesignation" => "E",
  #           "TimeTabledDateTime" => "2023-07-02T17:04:00",
  #             "ExpectedDateTime" => "2023-07-02T17:04:00",
  #                  "DisplayTime" => "3 min",
  #                "JourneyNumber" => 29038,
  #                   "Deviations" => nil
  #     },
  #     [ 4] {
  #                  "GroupOfLine" => nil,
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "714",
  #                  "Destination" => "Flottsbro",
  #             "JourneyDirection" => 1,
  #                 "StopAreaName" => "Huddinge station",
  #               "StopAreaNumber" => 70108,
  #              "StopPointNumber" => 70108,
  #         "StopPointDesignation" => "I",
  #           "TimeTabledDateTime" => "2023-07-02T17:04:00",
  #             "ExpectedDateTime" => "2023-07-02T17:04:00",
  #                  "DisplayTime" => "3 min",
  #                "JourneyNumber" => 30259,
  #                   "Deviations" => nil
  #     },
  #     [ 5] {
  #                  "GroupOfLine" => nil,
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "712",
  #                  "Destination" => "Björnkulla",
  #             "JourneyDirection" => 2,
  #                 "StopAreaName" => "Huddinge station",
  #               "StopAreaNumber" => 70108,
  #              "StopPointNumber" => 70177,
  #         "StopPointDesignation" => "C",
  #           "TimeTabledDateTime" => "2023-07-02T17:05:00",
  #             "ExpectedDateTime" => "2023-07-02T17:05:00",
  #                  "DisplayTime" => "17:05",
  #                "JourneyNumber" => 29928,
  #                   "Deviations" => nil
  #     },
  #     [ 6] {
  #                  "GroupOfLine" => nil,
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "744",
  #                  "Destination" => "Gladö kvarn",
  #             "JourneyDirection" => 2,
  #                 "StopAreaName" => "Huddinge centrum",
  #               "StopAreaNumber" => 70088,
  #              "StopPointNumber" => 70089,
  #         "StopPointDesignation" => "K",
  #           "TimeTabledDateTime" => "2023-07-02T17:05:00",
  #             "ExpectedDateTime" => "2023-07-02T17:06:53",
  #                  "DisplayTime" => "6 min",
  #                "JourneyNumber" => 32670,
  #                   "Deviations" => nil
  #     },
  #     [ 7] {
  #                  "GroupOfLine" => nil,
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "742",
  #                  "Destination" => "Drevviksstrand",
  #             "JourneyDirection" => 1,
  #                 "StopAreaName" => "Huddinge centrum",
  #               "StopAreaNumber" => 70088,
  #              "StopPointNumber" => 70346,
  #         "StopPointDesignation" => "N",
  #           "TimeTabledDateTime" => "2023-07-02T17:06:00",
  #             "ExpectedDateTime" => "2023-07-02T17:06:56",
  #                  "DisplayTime" => "6 min",
  #                "JourneyNumber" => 32481,
  #                   "Deviations" => nil
  #     },
  #     [ 8] {
  #                  "GroupOfLine" => nil,
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "742",
  #                  "Destination" => "Huddinge sjukhus",
  #             "JourneyDirection" => 2,
  #                 "StopAreaName" => "Huddinge centrum",
  #               "StopAreaNumber" => 70088,
  #              "StopPointNumber" => 70345,
  #         "StopPointDesignation" => "L",
  #           "TimeTabledDateTime" => "2023-07-02T17:10:00",
  #             "ExpectedDateTime" => "2023-07-02T17:12:16",
  #                  "DisplayTime" => "11 min",
  #                "JourneyNumber" => 32512,
  #                   "Deviations" => nil
  #     },
  #     [ 9] {
  #                  "GroupOfLine" => "blåbuss",
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "172",
  #                  "Destination" => "Skarpnäck",
  #             "JourneyDirection" => 1,
  #                 "StopAreaName" => "Huddinge station",
  #               "StopAreaNumber" => 70108,
  #              "StopPointNumber" => 70117,
  #         "StopPointDesignation" => "G",
  #           "TimeTabledDateTime" => "2023-07-02T17:13:00",
  #             "ExpectedDateTime" => "2023-07-02T17:13:00",
  #                  "DisplayTime" => "12 min",
  #                "JourneyNumber" => 19263,
  #                   "Deviations" => nil
  #     },
  #     [10] {
  #                  "GroupOfLine" => "blåbuss",
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "172",
  #                  "Destination" => "Norsborg",
  #             "JourneyDirection" => 2,
  #                 "StopAreaName" => "Huddinge station",
  #               "StopAreaNumber" => 70108,
  #              "StopPointNumber" => 70479,
  #         "StopPointDesignation" => "B",
  #           "TimeTabledDateTime" => "2023-07-02T17:17:00",
  #             "ExpectedDateTime" => "2023-07-02T17:17:00",
  #                  "DisplayTime" => "16 min",
  #                "JourneyNumber" => 19319,
  #                   "Deviations" => nil
  #     },
  #     [11] {
  #                  "GroupOfLine" => nil,
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "710",
  #                  "Destination" => "Skärholmen",
  #             "JourneyDirection" => 2,
  #                 "StopAreaName" => "Huddinge centrum",
  #               "StopAreaNumber" => 70088,
  #              "StopPointNumber" => 70088,
  #         "StopPointDesignation" => "M",
  #           "TimeTabledDateTime" => "2023-07-02T17:20:00",
  #             "ExpectedDateTime" => "2023-07-02T17:20:00",
  #                  "DisplayTime" => "19 min",
  #                "JourneyNumber" => 29683,
  #                   "Deviations" => nil
  #     },
  #     [12] {
  #                  "GroupOfLine" => nil,
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "744",
  #                  "Destination" => "Högdalen",
  #             "JourneyDirection" => 1,
  #                 "StopAreaName" => "Huddinge centrum",
  #               "StopAreaNumber" => 70088,
  #              "StopPointNumber" => 70088,
  #         "StopPointDesignation" => "M",
  #           "TimeTabledDateTime" => "2023-07-02T17:25:00",
  #             "ExpectedDateTime" => "2023-07-02T17:25:26",
  #                  "DisplayTime" => "24 min",
  #                "JourneyNumber" => 32639,
  #                   "Deviations" => nil
  #     },
  #     [13] {
  #                  "GroupOfLine" => "blåbuss",
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "172",
  #                  "Destination" => "Skarpnäck",
  #             "JourneyDirection" => 1,
  #                 "StopAreaName" => "Huddinge station",
  #               "StopAreaNumber" => 70108,
  #              "StopPointNumber" => 70117,
  #         "StopPointDesignation" => "G",
  #           "TimeTabledDateTime" => "2023-07-02T17:28:00",
  #             "ExpectedDateTime" => "2023-07-02T17:29:00",
  #                  "DisplayTime" => "28 min",
  #                "JourneyNumber" => 19264,
  #                   "Deviations" => nil
  #     },
  #     [14] {
  #                  "GroupOfLine" => nil,
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "740",
  #                  "Destination" => "Kungens kurva",
  #             "JourneyDirection" => 2,
  #                 "StopAreaName" => "Huddinge station",
  #               "StopAreaNumber" => 70108,
  #              "StopPointNumber" => 70357,
  #         "StopPointDesignation" => "D",
  #           "TimeTabledDateTime" => "2023-07-02T17:31:00",
  #             "ExpectedDateTime" => "2023-07-02T17:31:00",
  #                  "DisplayTime" => "17:31",
  #                "JourneyNumber" => 32199,
  #                   "Deviations" => nil
  #     },
  #     [15] {
  #                  "GroupOfLine" => nil,
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "704",
  #                  "Destination" => "Fruängen",
  #             "JourneyDirection" => 1,
  #                 "StopAreaName" => "Huddinge station",
  #               "StopAreaNumber" => 70108,
  #              "StopPointNumber" => 70310,
  #         "StopPointDesignation" => "F",
  #           "TimeTabledDateTime" => "2023-07-02T17:31:00",
  #             "ExpectedDateTime" => "2023-07-02T17:31:00",
  #                  "DisplayTime" => "17:31",
  #                "JourneyNumber" => 28733,
  #                   "Deviations" => nil
  #     },
  #     [16] {
  #                  "GroupOfLine" => nil,
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "710",
  #                  "Destination" => "Sörskogen",
  #             "JourneyDirection" => 1,
  #                 "StopAreaName" => "Huddinge centrum",
  #               "StopAreaNumber" => 70088,
  #              "StopPointNumber" => 70089,
  #         "StopPointDesignation" => "K",
  #           "TimeTabledDateTime" => "2023-07-02T17:31:00",
  #             "ExpectedDateTime" => "2023-07-02T17:31:50",
  #                  "DisplayTime" => "17:31",
  #                "JourneyNumber" => 29649,
  #                   "Deviations" => nil
  #     },
  #     [17] {
  #                  "GroupOfLine" => "blåbuss",
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "172",
  #                  "Destination" => "Norsborg",
  #             "JourneyDirection" => 2,
  #                 "StopAreaName" => "Huddinge station",
  #               "StopAreaNumber" => 70108,
  #              "StopPointNumber" => 70479,
  #         "StopPointDesignation" => "B",
  #           "TimeTabledDateTime" => "2023-07-02T17:32:00",
  #             "ExpectedDateTime" => "2023-07-02T17:32:00",
  #                  "DisplayTime" => "17:32",
  #                "JourneyNumber" => 19320,
  #                   "Deviations" => nil
  #     },
  #     [18] {
  #                  "GroupOfLine" => nil,
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "714",
  #                  "Destination" => "Fredriksdal",
  #             "JourneyDirection" => 1,
  #                 "StopAreaName" => "Huddinge station",
  #               "StopAreaNumber" => 70108,
  #              "StopPointNumber" => 70108,
  #         "StopPointDesignation" => "I",
  #           "TimeTabledDateTime" => "2023-07-02T17:34:00",
  #             "ExpectedDateTime" => "2023-07-02T17:34:00",
  #                  "DisplayTime" => "17:34",
  #                "JourneyNumber" => 30260,
  #                   "Deviations" => nil
  #     },
  #     [19] {
  #                  "GroupOfLine" => nil,
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "712",
  #                  "Destination" => "Björnkulla",
  #             "JourneyDirection" => 2,
  #                 "StopAreaName" => "Huddinge station",
  #               "StopAreaNumber" => 70108,
  #              "StopPointNumber" => 70177,
  #         "StopPointDesignation" => "C",
  #           "TimeTabledDateTime" => "2023-07-02T17:35:00",
  #             "ExpectedDateTime" => "2023-07-02T17:35:00",
  #                  "DisplayTime" => "17:35",
  #                "JourneyNumber" => 29929,
  #                   "Deviations" => nil
  #     },
  #     [20] {
  #                  "GroupOfLine" => nil,
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "709",
  #                  "Destination" => "Länna handelsplats",
  #             "JourneyDirection" => 1,
  #                 "StopAreaName" => "Huddinge station",
  #               "StopAreaNumber" => 70108,
  #              "StopPointNumber" => 70108,
  #         "StopPointDesignation" => "I",
  #           "TimeTabledDateTime" => "2023-07-02T17:35:00",
  #             "ExpectedDateTime" => "2023-07-02T17:35:00",
  #                  "DisplayTime" => "17:35",
  #                "JourneyNumber" => 29532,
  #                   "Deviations" => nil
  #     },
  #     [21] {
  #                  "GroupOfLine" => nil,
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "744",
  #                  "Destination" => "Gladö kvarn",
  #             "JourneyDirection" => 2,
  #                 "StopAreaName" => "Huddinge centrum",
  #               "StopAreaNumber" => 70088,
  #              "StopPointNumber" => 70089,
  #         "StopPointDesignation" => "K",
  #           "TimeTabledDateTime" => "2023-07-02T17:35:00",
  #             "ExpectedDateTime" => "2023-07-02T17:35:00",
  #                  "DisplayTime" => "17:35",
  #                "JourneyNumber" => 32671,
  #                   "Deviations" => nil
  #     },
  #     [22] {
  #                  "GroupOfLine" => nil,
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "705",
  #                  "Destination" => "Solgård",
  #             "JourneyDirection" => 2,
  #                 "StopAreaName" => "Huddinge centrum",
  #               "StopAreaNumber" => 70088,
  #              "StopPointNumber" => 70345,
  #         "StopPointDesignation" => "L",
  #           "TimeTabledDateTime" => "2023-07-02T17:36:00",
  #             "ExpectedDateTime" => "2023-07-02T17:36:00",
  #                  "DisplayTime" => "17:36",
  #                "JourneyNumber" => 28942,
  #                   "Deviations" => nil
  #     },
  #     [23] {
  #                  "GroupOfLine" => nil,
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "742",
  #                  "Destination" => "Drevviksstrand",
  #             "JourneyDirection" => 1,
  #                 "StopAreaName" => "Huddinge centrum",
  #               "StopAreaNumber" => 70088,
  #              "StopPointNumber" => 70346,
  #         "StopPointDesignation" => "N",
  #           "TimeTabledDateTime" => "2023-07-02T17:36:00",
  #             "ExpectedDateTime" => "2023-07-02T17:36:00",
  #                  "DisplayTime" => "17:36",
  #                "JourneyNumber" => 32482,
  #                   "Deviations" => nil
  #     },
  #     [24] {
  #                  "GroupOfLine" => nil,
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "742",
  #                  "Destination" => "Huddinge sjukhus",
  #             "JourneyDirection" => 2,
  #                 "StopAreaName" => "Huddinge centrum",
  #               "StopAreaNumber" => 70088,
  #              "StopPointNumber" => 70345,
  #         "StopPointDesignation" => "L",
  #           "TimeTabledDateTime" => "2023-07-02T17:40:00",
  #             "ExpectedDateTime" => "2023-07-02T17:40:00",
  #                  "DisplayTime" => "17:40",
  #                "JourneyNumber" => 32513,
  #                   "Deviations" => nil
  #     },
  #     [25] {
  #                  "GroupOfLine" => "blåbuss",
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "172",
  #                  "Destination" => "Skarpnäck",
  #             "JourneyDirection" => 1,
  #                 "StopAreaName" => "Huddinge station",
  #               "StopAreaNumber" => 70108,
  #              "StopPointNumber" => 70117,
  #         "StopPointDesignation" => "G",
  #           "TimeTabledDateTime" => "2023-07-02T17:43:00",
  #             "ExpectedDateTime" => "2023-07-02T17:43:43",
  #                  "DisplayTime" => "17:43",
  #                "JourneyNumber" => 19265,
  #                   "Deviations" => nil
  #     },
  #     [26] {
  #                  "GroupOfLine" => "blåbuss",
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "172",
  #                  "Destination" => "Norsborg",
  #             "JourneyDirection" => 2,
  #                 "StopAreaName" => "Huddinge station",
  #               "StopAreaNumber" => 70108,
  #              "StopPointNumber" => 70479,
  #         "StopPointDesignation" => "B",
  #           "TimeTabledDateTime" => "2023-07-02T17:47:00",
  #             "ExpectedDateTime" => "2023-07-02T17:47:00",
  #                  "DisplayTime" => "17:47",
  #                "JourneyNumber" => 19321,
  #                   "Deviations" => nil
  #     },
  #     [27] {
  #                  "GroupOfLine" => nil,
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "705",
  #                  "Destination" => "Stuvsta station",
  #             "JourneyDirection" => 1,
  #                 "StopAreaName" => "Huddinge centrum",
  #               "StopAreaNumber" => 70088,
  #              "StopPointNumber" => 70346,
  #         "StopPointDesignation" => "N",
  #           "TimeTabledDateTime" => "2023-07-02T17:48:00",
  #             "ExpectedDateTime" => "2023-07-02T17:48:00",
  #                  "DisplayTime" => "17:48",
  #                "JourneyNumber" => 28919,
  #                   "Deviations" => nil
  #     },
  #     [28] {
  #                  "GroupOfLine" => nil,
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "710",
  #                  "Destination" => "Skärholmen",
  #             "JourneyDirection" => 2,
  #                 "StopAreaName" => "Huddinge centrum",
  #               "StopAreaNumber" => 70088,
  #              "StopPointNumber" => 70088,
  #         "StopPointDesignation" => "M",
  #           "TimeTabledDateTime" => "2023-07-02T17:51:00",
  #             "ExpectedDateTime" => "2023-07-02T17:51:00",
  #                  "DisplayTime" => "17:51",
  #                "JourneyNumber" => 29684,
  #                   "Deviations" => nil
  #     },
  #     [29] {
  #                  "GroupOfLine" => nil,
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "744",
  #                  "Destination" => "Högdalen",
  #             "JourneyDirection" => 1,
  #                 "StopAreaName" => "Huddinge centrum",
  #               "StopAreaNumber" => 70088,
  #              "StopPointNumber" => 70088,
  #         "StopPointDesignation" => "M",
  #           "TimeTabledDateTime" => "2023-07-02T17:55:00",
  #             "ExpectedDateTime" => "2023-07-02T17:55:00",
  #                  "DisplayTime" => "17:55",
  #                "JourneyNumber" => 32640,
  #                   "Deviations" => nil
  #     },
  #     [30] {
  #                  "GroupOfLine" => "blåbuss",
  #                "TransportMode" => "BUS",
  #                   "LineNumber" => "172",
  #                  "Destination" => "Skarpnäck",
  #             "JourneyDirection" => 1,
  #                 "StopAreaName" => "Huddinge station",
  #               "StopAreaNumber" => 70108,
  #              "StopPointNumber" => 70117,
  #         "StopPointDesignation" => "G",
  #           "TimeTabledDateTime" => "2023-07-02T17:58:00",
  #             "ExpectedDateTime" => "2023-07-02T17:58:00",
  #                  "DisplayTime" => "17:58",
  #                "JourneyNumber" => 19266,
  #                   "Deviations" => nil
  #     }
  # ],
    
    # Filter for northbound trains that aren't cancelled
    northbound_trains = @data['ResponseData']['Trains'].select do |train| 
      train['JourneyDirection'] == 2
      # && (train['Deviations'].nil? || train['Deviations'].none? { |deviation| deviation['Text'].include?('Inställd') })
    end

    # Map to desired format
    now = DateTime.now.new_offset('+02:00')
    departures = northbound_trains.map do |train|
      departure_time = DateTime.parse(train['ExpectedDateTime'] + '+02:00')
      minutes_until_departure = ((departure_time - now) * 24 * 60).to_i
      #display_time = "#{minutes_until_departure / 60}h #{minutes_until_departure % 60}m"
      display_time = departure_time.strftime('%H:%M')
      time_of_departure = minutes_until_departure > 59 ? display_time : "om #{minutes_until_departure}m - #{display_time}"

      deviation_note = ''
      summary_deviation_note = ''
      if train['Deviations']
        deviation_note = train['Deviations'].map { |deviation| deviation['Text'].strip }.join(', ')
        summary_deviation_note = ' (försenad)' if deviation_note.include?('Försenad')
        summary_deviation_note = ' (inställd)' if deviation_note.include?('Inställd')
      end

      {
        'destination': train['Destination'],
        'line_number': train['LineNumber'],
        'departure_time': departure_time,
        'minutes_until_departure': minutes_until_departure,
        'time_of_departure': time_of_departure,
        'deviation_note': deviation_note,
        'summary_deviation_note': summary_deviation_note
      }
    end
    
    # Construct deviation summary string
    deviation_summary = departures.map do |d|
      unless d[:deviation_note].empty?
        "#{d[:departure_time].strftime('%H:%M')} till #{d[:destination]}: #{d[:deviation_note].downcase}"
      end
    end.compact.join(" ")

    # Filter for northbound trains that aren't cancelled and aren't past rushing to the station
    departures = departures.select do |d|
      d[:summary_deviation_note] != ' (inställd)' &&
      d[:minutes_until_departure] > RUN_TIME
    end

    first_train_you_can_catch = departures.find { |d| d[:minutes_until_departure] > RUN_TIME }
    if first_train_you_can_catch
      first_train_you_can_catch[:late] = first_train_you_can_catch[:minutes_until_departure] < WALK_TIME
      first_train_you_can_catch[:suffix] = if first_train_you_can_catch[:late]
                                             "spring eller cykla!"
                                           elsif first_train_you_can_catch[:minutes_until_departure] > (WALK_TIME + MARGIN_TIME + 5) # E.g. 8 + 5 + 5 = 18 mins
                                            alarm_time = first_train_you_can_catch[:departure_time] - (WALK_TIME + MARGIN_TIME) / (24 * 60.0)
                                            "ställ larm på #{alarm_time.strftime("%H:%M")}"
                                           else
                                             "du hinner gå till #{first_train_you_can_catch[:departure_time].strftime("%H:%M")}!"
                                           end
    end
    
    departures.each { |d| d[:departure_time] = d[:departure_time].strftime('%H:%M') }

    # Construct summary string
    departure_times = departures.map { |d| "#{d[:time_of_departure]}#{d[:summary_deviation_note]}" }
    
    summary = "Pendeltåg norrut avgår #{to_sentence(departure_times)}"
    summary = "Inga pendeltåg avgår norrut inom 30m" if departure_times.empty? || departure_times.all? { |t| t.include?('inställt') }

    # Add suffix to summary if there is one
    if first_train_you_can_catch && !first_train_you_can_catch[:suffix].empty?
      summary += " - #{first_train_you_can_catch[:suffix]}"
    end

    response = {
      'summary': summary,
      'deviation_summary': deviation_summary,
      'departures': departures
    }

    [200, { 'Content-Type' => 'application/json' }, [ Oj.dump(response) ]]
  end
end

home_page_handler = HomePageHandler.new
electricity_stats_handler = ElectricityStatsHandler.new
proxy_handler = ProxyHandler.new
static_handler = StaticHandler.new
train_departure_handler = TrainDepartureHandler.new

Agoo::Server.handle(:GET, "/", home_page_handler)
Agoo::Server.handle(:GET, "/*", static_handler)
Agoo::Server.handle(:GET, "/data/electricity", electricity_stats_handler)
Agoo::Server.handle(:GET, "/data/train_departures", train_departure_handler)
Agoo::Server.handle(:GET, "/data/*", proxy_handler)
Agoo::Server.start()